import Head from 'next/head'
import { Inter } from '@next/font/google'
import styled from 'styled-components'
import Banner from '@/components/banners/Banner'
import { extendedClothesSlice, useGetAllClothesQuery , selectAllClothes, ClotheType} from '@/lib/slices/clothesSlice'
import ClothesGallery from '@/components/clothes/ClothesGallery'
import { useAppDispatch, useAppSelector } from 'lib/hooks/hooks'
import PacmanLoader from 'react-spinners/PacmanLoader'
import { selectUser, useGetUserQuery, useRegisterMutation } from '@/lib/slices/userSlice'
import { useEffect, useState } from 'react'
import { loggedIn, setAuth, setEmailOnLogin, signOut } from '@/lib/slices/authSlice'
import { RootState } from '@/lib/store'

import { Auth, Hub } from 'aws-amplify'
import { apiSlice } from '@/lib/slices/apiSlice'
import router from 'next/router'

const inter = Inter({ subsets: ['latin'] })

extendedClothesSlice.endpoints.getAllClothes.initiate()

export default function Home() {

  const selectAll = useAppSelector(selectAllClothes)
  const [randomClothes, setRandomClothes] = useState<ClotheType[]>([])
  const userEmail = useAppSelector(state => state.auth.email)
  const userData = useAppSelector((state: RootState) => selectUser(state, userEmail))
  const dispatch = useAppDispatch()
  const [tokenSent, setTokenSent] = useState(false)


  const {
    isLoading,
    isSuccess,
    isError,
    error
  } = useGetAllClothesQuery()

  const {
    data: user,
    isLoading: userIsLoading,
    isSuccess: userIsSuccess,
    isError: userIsError,
    error: userError
  } = useGetUserQuery(userEmail)
  
  const [registerUser, {
    data,
    isLoading: registerLoading,
    error: registerError }
  ] = useRegisterMutation()



  // Wrapped in a useEffect to avoid re rendering when getUser fires
  useEffect(() => {
    if (isLoading) {
    } else if (isSuccess) {
      setRandomClothes([...selectAll].sort(() => Math.random() - 0.5))
    } else if (isError) {
      console.log(JSON.stringify(error))
    }

  }, [isSuccess, isError, selectAll, isLoading])

  const handleUserRegistration = (idToken: string, accessToken: string) => {
    registerUser({
      email: idToken,
      cognitoId: accessToken
    });
  };
  

  // COGNITO AUTH
  useEffect(() => {
    const unsubscribe = Hub.listen("auth", ({ payload: { event, data } }) => {
      switch (event) {
        case "signIn":
          // SET HEADER TOKEN
          dispatch(setAuth(data.signInUserSession.accessToken.jwtToken))
          // ONE ATTEMPT AT REGISTERING THE USER
          if (!tokenSent) { 
            let { signInUserSession } = data
            let { accessToken, idToken } = signInUserSession
            handleUserRegistration(idToken.payload.email, accessToken.payload.sub)
          }
          console.log('USER REGISTERED :: :: ::')
          setTokenSent(true)
          break;
        case "signOut":
          dispatch(signOut)
          break;
        case "customOAuthState":
          //! read about why this exist 
      }
    });

    Auth.currentAuthenticatedUser() // EMAIL AND JWT IS USED FOR THE SERVER SIDE AUTH 
      .then(currentUser => (
        dispatch(setEmailOnLogin(currentUser.attributes.email)),
        dispatch(loggedIn(true))
        ),
      )
      .catch(() => console.log("Not signed in"));
    return unsubscribe;
  }, [])



  const firstBanner = {
    banner: '#95f7e5',
    header: 'UP TO 30% OFF ',
    header2: ' SELECTED STOCK',
    subheader: 'Surprise discount unlocked',
    subheader2: 'With code: ',
    subheader3: 'SURPRISE'
  } as const
  const secondBanner = {
    banner: '#FF385C',
    header: 'UP TO 50% OFF ',
    header2: ' SUMMER STUFF',
    subheader: 'ITS HOT OUT THERE',
    subheader2: '',
    subheader3: ''
  } as const

  async function handleLogout() {
    localStorage.removeItem('key')
    try {
      dispatch(signOut())
      await Auth.signOut()
    }
    catch (err) {
      console.log(err)
    } finally {
      dispatch(apiSlice.util.resetApiState())
      router.push('/login')
    }
  }

  return (
    <>
      <Head>
        <title>Welcome!</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Wrapper>
      <button onClick={() => handleLogout()}>
              Log out
            </button>
        <Banner info={firstBanner} />
        <PacmanLoader
          color={'#2d2d2d'}
          size={50}
          loading={isLoading}
          cssOverride={{
            display: 'block', height: '450px', margin: 'auto', marginTop: '200px'
          }}
        />
        {isSuccess &&
          <ClothesGallery info={randomClothes!} />
        }
        <Banner info={secondBanner} />
      </Wrapper>

    </>
  )
}

const Wrapper = styled.main`
  position: absolute;
  left: 0;
  top: 155px;
  width: 100%;
  height: auto;
`
